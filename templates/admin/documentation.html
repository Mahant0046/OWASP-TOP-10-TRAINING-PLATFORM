{% extends "admin/base.html" %}
{% block title %}Documentation Management - Admin{% endblock %}

{% block content %}
<div class="admin-header">
    <h1><i class="fas fa-book"></i> Documentation Management</h1>
    <div class="admin-actions">
        <a href="{{ url_for('admin_create_documentation') }}" class="btn btn--primary">
            <i class="fas fa-plus"></i> Create New Documentation
        </a>
    </div>
</div>

<div class="admin-content">
    <!-- Documentation Overview -->
    <div class="admin-card">
        <div class="card-header">
            <h3><i class="fas fa-chart-bar"></i> Documentation Overview</h3>
        </div>
        <div class="card-body">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-file-alt"></i></div>
                    <div class="stat-content">
                        <div class="stat-number">{{ docs | length }}</div>
                        <div class="stat-label">Total Documents</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-eye"></i></div>
                    <div class="stat-content">
                        <div class="stat-number">{{ docs | selectattr('is_published') | list | length }}</div>
                        <div class="stat-label">Published</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-users"></i></div>
                    <div class="stat-content">
                        <div class="stat-number">
                            {% set total_readers = 0 %}
                            {% for stat in stats_by_module.values() %}
                                {% set total_readers = total_readers + (stat.unique_readers or 0) %}
                            {% endfor %}
                            {{ total_readers }}
                        </div>
                        <div class="stat-label">Total Readers</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-content">
                        <div class="stat-number">
                            {% set completed_reads = 0 %}
                            {% for stat in stats_by_module.values() %}
                                {% set completed_reads = completed_reads + (stat.completed_readers or 0) %}
                            {% endfor %}
                            {{ completed_reads }}
                        </div>
                        <div class="stat-label">Completed Reads</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Documentation List -->
    {% if docs %}
    <div class="admin-card">
        <div class="card-header">
            <h3><i class="fas fa-list"></i> All Documentation</h3>
        </div>
        <div class="card-body">
            <div class="docs-table">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Module</th>
                            <th>Title</th>
                            <th>Author</th>
                            <th>Difficulty</th>
                            <th>Read Time</th>
                            <th>Status</th>
                            <th>Readers</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for doc in docs %}
                        <tr class="{{ 'inactive' if not doc.is_published }}">
                            <td>
                                <span class="module-badge">{{ doc.module_id }}</span>
                            </td>
                            <td class="doc-title">
                                <strong>{{ doc.title }}</strong>
                                {% if doc.tags %}
                                <div class="doc-tags">
                                    {% for tag in doc.tags %}
                                    <span class="tag">{{ tag }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </td>
                            <td>{{ doc.author or 'OWASP Team' }}</td>
                            <td>
                                <span class="difficulty-badge difficulty-{{ doc.difficulty.lower() }}">
                                    {{ doc.difficulty }}
                                </span>
                            </td>
                            <td>{{ doc.estimated_read_time }} min</td>
                            <td>
                                {% if doc.is_published %}
                                    <span class="status-badge status-published">Published</span>
                                {% else %}
                                    <span class="status-badge status-draft">Draft</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if doc.module_id in stats_by_module %}
                                <div class="reader-stats">
                                    <div class="stat-item">
                                        <i class="fas fa-users"></i>
                                        {{ stats_by_module[doc.module_id].unique_readers or 0 }}
                                    </div>
                                    <div class="stat-item">
                                        <i class="fas fa-check"></i>
                                        {{ stats_by_module[doc.module_id].completed_readers or 0 }}
                                    </div>
                                </div>
                                {% else %}
                                <span class="text-muted">No readers yet</span>
                                {% endif %}
                            </td>
                            <td class="actions">
                                <a href="{{ url_for('admin_edit_documentation', doc_id=doc.id) }}" 
                                   class="btn btn--outline btn--xs" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                {% if admin.role == 'admin' %}
                                <form method="post" action="{{ url_for('admin_delete_documentation', doc_id=doc.id) }}" 
                                      style="display: inline;" 
                                      onsubmit="return confirm('Are you sure you want to delete this documentation?')">
                                    <button type="submit" class="btn btn--danger btn--xs" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="admin-card">
        <div class="card-body text-center">
            <div class="empty-state">
                <i class="fas fa-book fa-3x"></i>
                <h3>No Documentation</h3>
                <p>Get started by creating your first documentation.</p>
                <a href="{{ url_for('admin_create_documentation') }}" class="btn btn--primary">
                    <i class="fas fa-plus"></i> Create First Document
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.stat-card {
    display: flex;
    align-items: center;
    padding: 20px;
    background: var(--color-surface);
    border-radius: 8px;
    border: 1px solid var(--color-border);
}

.stat-icon {
    font-size: 24px;
    color: var(--color-primary);
    margin-right: 15px;
}

.stat-number {
    font-size: 24px;
    font-weight: bold;
    color: var(--color-text-primary);
}

.stat-label {
    font-size: 14px;
    color: var(--color-text-secondary);
}

.docs-table {
    overflow-x: auto;
}

.admin-table {
    width: 100%;
    border-collapse: collapse;
}

.admin-table th,
.admin-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--color-border);
}

.admin-table th {
    background: var(--color-bg-1);
    font-weight: 600;
    color: var(--color-text-primary);
}

.admin-table tr.inactive {
    opacity: 0.6;
}

.module-badge {
    display: inline-block;
    padding: 4px 8px;
    background: var(--color-primary);
    color: white;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
}

.doc-title {
    max-width: 300px;
}

.doc-title strong {
    display: block;
    margin-bottom: 4px;
}

.doc-tags {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
}

.tag {
    display: inline-block;
    padding: 2px 6px;
    background: var(--color-bg-2);
    color: var(--color-text-secondary);
    border-radius: 3px;
    font-size: 10px;
    font-weight: 500;
}

.difficulty-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}

.difficulty-easy {
    background: var(--color-bg-3);
    color: var(--color-success);
}

.difficulty-medium {
    background: var(--color-bg-2);
    color: var(--color-warning);
}

.difficulty-hard, .difficulty-critical, .difficulty-high {
    background: var(--color-bg-4);
    color: var(--color-danger);
}

.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}

.status-published {
    background: var(--color-bg-3);
    color: var(--color-success);
}

.status-draft {
    background: var(--color-bg-2);
    color: var(--color-warning);
}

.reader-stats {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    color: var(--color-text-secondary);
}

.stat-item i {
    width: 12px;
}

.actions {
    display: flex;
    gap: 8px;
}

.empty-state {
    padding: 40px;
}

.empty-state i {
    color: var(--color-text-secondary);
    margin-bottom: 20px;
}

.empty-state h3 {
    margin-bottom: 10px;
    color: var(--color-text-primary);
}

.empty-state p {
    color: var(--color-text-secondary);
    margin-bottom: 20px;
}

.text-muted {
    color: var(--color-text-secondary);
    font-size: 12px;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .doc-title {
        max-width: 200px;
    }
}
</style>
{% endblock %}
