{% extends "base.html" %}
{% block title %}{{ module.title }} - Assessment{% endblock %}

{% block content %}
<div class="learning-container">
    <div class="learning-header">
        <div class="breadcrumb">
            <a href="/dashboard">Dashboard</a> ‚Üí 
            <a href="/docs/{{ module_id }}">{{ module.title }}</a> ‚Üí 
            <span>Assessment</span>
        </div>
        <h1>‚úÖ {{ module.title }} - Knowledge Assessment</h1>
        <div class="learning-progress">
            <span class="step completed">üìñ Documentation</span>
            <span class="step completed">üé¨ Animation</span>
            <span class="step completed">üß™ Lab</span>
            <span class="step current">‚úÖ Assessment</span>
        </div>
    </div>

    <div class="assessment-container">
        <div class="assessment-info">
            <div class="info-card">
                <h3>üìã Assessment Information</h3>
                <ul>
                    <li><strong>Questions:</strong> <span id="question-count">Loading...</span></li>
                    <li><strong>Time Limit:</strong> 15 minutes</li>
                    <li><strong>Passing Score:</strong> 70%</li>
                    <li><strong>Attempts:</strong> Unlimited</li>
                </ul>
            </div>
            
            <div class="xp-info">
                <h3>üéØ XP Rewards</h3>
                <div class="xp-breakdown">
                    <div class="xp-item">
                        <span class="xp-label">Base Score:</span>
                        <span class="xp-value">+50 XP</span>
                    </div>
                    <div class="xp-item">
                        <span class="xp-label">High Score (80%+):</span>
                        <span class="xp-value">+25 XP Bonus</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="assessment-content">
            <div id="assessment-start" class="assessment-start">
                <h2>Ready to Test Your Knowledge?</h2>
                <p>This assessment will test your understanding of <strong>{{ module.title }}</strong> concepts, vulnerabilities, and countermeasures.</p>
                
                <div class="start-checklist">
                    <h4>Before you begin:</h4>
                    <label class="checklist-item">
                        <input type="checkbox" id="check-documentation">
                        <span>I have completed the documentation</span>
                    </label>
                    <label class="checklist-item">
                        <input type="checkbox" id="check-animation">
                        <span>I have watched the animation</span>
                    </label>
                    <label class="checklist-item">
                        <input type="checkbox" id="check-lab">
                        <span>I have completed the lab exercise</span>
                    </label>
                </div>

                <button id="start-assessment" class="btn btn--primary btn--large" disabled>
                    <i class="fas fa-play"></i> Start Assessment
                </button>
            </div>

            <div id="assessment-quiz" class="assessment-quiz" style="display: none;">
                <div class="quiz-header">
                    <div class="question-counter">
                        Question <span id="current-question">1</span> of <span id="total-questions">5</span>
                    </div>
                    <div class="timer">
                        Time: <span id="timer">15:00</span>
                    </div>
                </div>

                <div class="question-container">
                    <div class="question-text" id="question-text">
                        Loading question...
                    </div>
                    
                    <div class="answer-options" id="answer-options">
                        <!-- Options will be loaded here -->
                    </div>
                </div>

                <div class="quiz-navigation">
                    <button id="prev-question" class="btn btn--outline" disabled>
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    <button id="next-question" class="btn btn--primary" disabled>
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                    <button id="submit-assessment" class="btn btn--success" style="display: none;">
                        <i class="fas fa-check"></i> Submit Assessment
                    </button>
                </div>
            </div>

            <div id="assessment-results" class="assessment-results" style="display: none;">
                <div class="results-header">
                    <h2 id="results-title">Assessment Complete!</h2>
                    <div class="score-display">
                        <div class="score-circle">
                            <span id="final-score">0%</span>
                        </div>
                    </div>
                </div>

                <div class="results-breakdown">
                    <div class="result-item">
                        <span class="label">Correct Answers:</span>
                        <span class="value" id="correct-count">0/5</span>
                    </div>
                    <div class="result-item">
                        <span class="label">XP Earned:</span>
                        <span class="value" id="xp-earned">+50 XP</span>
                    </div>
                    <div class="result-item">
                        <span class="label">Time Taken:</span>
                        <span class="value" id="time-taken">0:00</span>
                    </div>
                </div>

                <div class="results-actions">
                    <button id="complete-module" data-module-id="{{ module_id }}" class="btn btn--primary btn--large" disabled style="opacity: 0.6;">
                        <i class="fas fa-trophy"></i> Complete Module & Unlock Next
                    </button>
                    <button id="retake-assessment" class="btn btn--outline">
                        <i class="fas fa-redo"></i> Retake Assessment
                    </button>
                    <button id="review-answers" class="btn btn--outline" style="display: none;">
                        <i class="fas fa-list-check"></i> Review Answers
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.learning-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.learning-header {
    margin-bottom: 30px;
}

.breadcrumb {
    font-size: 14px;
    color: var(--color-text-secondary);
    margin-bottom: 10px;
}

.breadcrumb a {
    color: var(--color-primary);
    text-decoration: none;
}

.learning-progress {
    display: flex;
    gap: 20px;
    margin-top: 20px;
}

.step {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 500;
}

.step.completed {
    background: var(--color-success);
    color: white;
}

.step.current {
    background: var(--color-primary);
    color: white;
}

.assessment-container {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 30px;
}

.assessment-info {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.info-card, .xp-info {
    background: var(--color-bg-1);
    border-radius: 12px;
    padding: 20px;
}

.info-card h3, .xp-info h3 {
    margin-top: 0;
    color: var(--color-primary);
}

.info-card ul {
    list-style: none;
    padding: 0;
}

.info-card li {
    padding: 8px 0;
    display: flex;
    justify-content: space-between;
}

.xp-breakdown {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.xp-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 12px;
    background: var(--color-bg-2);
    border-radius: 6px;
}

.xp-value {
    color: var(--color-success);
    font-weight: bold;
}

.assessment-content {
    background: var(--color-bg-1);
    border-radius: 12px;
    padding: 30px;
}

.assessment-start {
    text-align: center;
}

.start-checklist {
    margin: 30px 0;
    text-align: left;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
}

.checklist-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 10px 0;
    cursor: pointer;
}

.btn--large {
    padding: 15px 30px;
    font-size: 16px;
}

.quiz-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--color-bg-2);
}

.question-counter {
    font-weight: bold;
    color: var(--color-primary);
}

.timer {
    font-weight: bold;
    color: var(--color-warning);
}

.question-container {
    margin-bottom: 30px;
}

.question-text {
    font-size: 18px;
    font-weight: 500;
    margin-bottom: 20px;
    line-height: 1.6;
}

.answer-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.answer-option {
    padding: 15px;
    border: 2px solid var(--color-bg-2);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.answer-option:hover {
    border-color: var(--color-primary);
    background: var(--color-bg-2);
}

.answer-option.selected {
    border-color: var(--color-primary);
    background: var(--color-primary-light);
}

.quiz-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.results-header {
    text-align: center;
    margin-bottom: 30px;
}

.score-circle {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: var(--color-success);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 20px auto;
    color: white;
    font-size: 24px;
    font-weight: bold;
}

.results-breakdown {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 30px;
}

.result-item {
    display: flex;
    justify-content: space-between;
    padding: 15px;
    background: var(--color-bg-2);
    border-radius: 8px;
}

.results-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
}

@media (max-width: 768px) {
    .assessment-container {
        grid-template-columns: 1fr;
    }
    
    .results-actions {
        flex-direction: column;
    }
}

/* Review Modal Styles */
.review-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.review-item {
    padding: 20px;
    border-radius: 8px;
    border: 2px solid var(--color-border);
}

.review-item.correct {
    background: rgba(76, 175, 80, 0.1);
    border-color: var(--color-success);
}

.review-item.incorrect {
    background: rgba(244, 67, 54, 0.1);
    border-color: var(--color-error);
}

.review-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    font-weight: bold;
}

.review-number {
    color: var(--color-primary);
}

.review-status {
    font-size: 14px;
}

.review-question {
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 16px;
    color: var(--color-text);
}

.review-answers {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 12px;
}

.user-answer, .correct-answer {
    padding: 8px 12px;
    border-radius: 4px;
    background: var(--color-bg-2);
}

.correct-answer {
    background: rgba(76, 175, 80, 0.2);
}

.review-explanation {
    padding: 12px;
    background: var(--color-bg-1);
    border-left: 3px solid var(--color-primary);
    border-radius: 4px;
    font-size: 14px;
    color: var(--color-text-secondary);
}

/* Notification Styles */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.notification-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
}

.notification-close {
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
    padding: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.notification-close:hover {
    opacity: 0.8;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ Assessment page loaded for module: {{ module_id }}');
    
    // Add debug info
    console.log('User session check...');
    fetch('/api/gamification/user-stats')
        .then(response => response.json())
        .then(data => {
            console.log('User stats:', data);
        })
        .catch(error => {
            console.error('Error getting user stats:', error);
        });
    
    // Debug current gamification state
    setTimeout(() => {
        if (window.gamificationEngine && window.gamificationEngine.userProfile) {
            const unlockedModules = window.gamificationEngine.userProfile.unlockedModules;
            const completedModules = window.gamificationEngine.userProfile.completedModules;
            
            console.log('Current unlocked modules:', 
                unlockedModules ? Array.from(unlockedModules) : []);
            console.log('Current completed modules:', 
                completedModules ? Array.from(completedModules) : []);
        }
    }, 1000);
    
    // Initialize assessment system
    let currentQuestion = 0;
    let questions = [];
    let answers = {};
    let startTime = null;
    
    // Load questions
    loadQuestions();
    
    // Setup checklist validation
    const checkboxes = document.querySelectorAll('.checklist-item input');
    const startBtn = document.getElementById('start-assessment');
    
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', validateChecklist);
    });
    
    function validateChecklist() {
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        startBtn.disabled = !allChecked;
    }
    
    // Start assessment
    startBtn?.addEventListener('click', startAssessment);
    
    function loadQuestions() {
        fetch(`/api/assessments/{{ module_id }}/questions`)
            .then(response => response.json())
            .then(data => {
                let useFallback = false;
                if (!data || data.success !== true || !Array.isArray(data.questions) || data.questions.length === 0) {
                    useFallback = true;
                } else {
                    // Validate shape for frontend quiz (requires question, options[], correct index)
                    const q0 = data.questions[0] || {};
                    if (!('question' in q0) || !Array.isArray(q0.options) || !('correct' in q0)) {
                        useFallback = true;
                    }
                }

                questions = useFallback ? generateFallbackQuestions() : data.questions;
                document.getElementById('question-count').textContent = questions.length;
                document.getElementById('total-questions').textContent = questions.length;
            })
            .catch(error => {
                console.error('Error loading questions:', error);
                questions = generateFallbackQuestions();
                document.getElementById('question-count').textContent = questions.length;
                document.getElementById('total-questions').textContent = questions.length;
            });
    }
    
    function generateFallbackQuestions() {
        return [
            {
                id: 1,
                question: "What is the primary concern with {{ module.title }}?",
                options: ["Security vulnerability", "Performance issue", "Compatibility problem", "Design flaw"],
                correct: 0
            },
            {
                id: 2,
                question: "Which of the following is a common mitigation for {{ module.title }}?",
                options: ["Input validation", "Output encoding", "Access controls", "All of the above"],
                correct: 3
            }
        ];
    }
    
    function startAssessment() {
        document.getElementById('assessment-start').style.display = 'none';
        document.getElementById('assessment-quiz').style.display = 'block';
        startTime = new Date();
        startTimer();
        loadQuestion(0);
    }
    
    function startTimer() {
        let timeLeft = 15 * 60; // 15 minutes
        const timerElement = document.getElementById('timer');
        
        const timer = setInterval(() => {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 0) {
                clearInterval(timer);
                submitAssessment();
            }
            timeLeft--;
        }, 1000);
    }
    
    function loadQuestion(index) {
        if (index >= questions.length) return;
        
        const question = questions[index];
        document.getElementById('current-question').textContent = index + 1;
        document.getElementById('question-text').textContent = question.question;
        
        const optionsContainer = document.getElementById('answer-options');
        optionsContainer.innerHTML = '';
        
        question.options.forEach((option, i) => {
            const optionElement = document.createElement('div');
            optionElement.className = 'answer-option';
            optionElement.textContent = option;
            optionElement.addEventListener('click', () => selectAnswer(i));
            optionsContainer.appendChild(optionElement);
        });
        
        // Restore previous selection if exists
        const questionId = question.id;
        if (questionId in answers) {
            const selectedIndex = answers[questionId];
            document.querySelectorAll('.answer-option').forEach((el, i) => {
                el.classList.toggle('selected', i === selectedIndex);
            });
        }
        
        updateNavigation();
    }
    
    function selectAnswer(optionIndex) {
        const questionId = questions[currentQuestion].id;
        answers[questionId] = optionIndex;
        
        // Update UI
        document.querySelectorAll('.answer-option').forEach((el, i) => {
            el.classList.toggle('selected', i === optionIndex);
        });
        
        document.getElementById('next-question').disabled = false;
    }
    
    function updateNavigation() {
        const currentQuestionId = questions[currentQuestion].id;
        document.getElementById('prev-question').disabled = currentQuestion === 0;
        document.getElementById('next-question').disabled = !(currentQuestionId in answers);
        
        if (currentQuestion === questions.length - 1) {
            document.getElementById('next-question').style.display = 'none';
            document.getElementById('submit-assessment').style.display = 'inline-block';
        }
    }
    
    // Navigation handlers
    document.getElementById('next-question')?.addEventListener('click', () => {
        if (currentQuestion < questions.length - 1) {
            currentQuestion++;
            loadQuestion(currentQuestion);
        }
    });
    
    document.getElementById('prev-question')?.addEventListener('click', () => {
        if (currentQuestion > 0) {
            currentQuestion--;
            loadQuestion(currentQuestion);
        }
    });
    
    document.getElementById('submit-assessment')?.addEventListener('click', submitAssessment);
    
    function submitAssessment() {
        const endTime = new Date();
        const timeTaken = Math.floor((endTime - startTime) / 1000);
        
        // Calculate score
        let correct = 0;
        questions.forEach((question) => {
            const userAnswer = answers[question.id];
            const correctAnswer = question.correct;
            const isCorrect = userAnswer === correctAnswer;
            
            console.log(`Question ${question.id}: User answered ${userAnswer}, Correct is ${correctAnswer}, Match: ${isCorrect}`);
            
            if (isCorrect) {
                correct++;
            }
        });
        
        const score = Math.round((correct / questions.length) * 100);
        console.log(`Final score: ${correct}/${questions.length} = ${score}%`);
        window.assessmentScore = score;
        
        // Submit to server for processing
        submitToServer(score, timeTaken);
    }
    
    function submitToServer(score, timeTaken) {
        // Create assessment attempt first
        fetch(`/api/assessments/{{ module_id }}/start`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                module_id: '{{ module_id }}'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data) {
                // Check if there are no questions
                if (data.data.no_questions || data.data.total_questions === 0) {
                    // Submit directly without attempt_id for modules without questions
                    return fetch(`/api/assessments/{{ module_id }}/submit`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            attempt_id: null,
                            answers: {},
                            time_taken: timeTaken
                        })
                    });
                } else if (data.data.attempt_id) {
                    // Normal flow with questions
                    return fetch(`/api/assessments/{{ module_id }}/submit`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            attempt_id: data.data.attempt_id,
                            answers: answers,
                            time_taken: timeTaken
                        })
                    });
                } else {
                    throw new Error('Failed to create assessment attempt');
                }
            } else {
                throw new Error(data.error || 'Failed to start assessment');
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                handleAssessmentResult(result.data);
            } else {
                throw new Error(result.error || 'Failed to submit assessment');
            }
        })
        .catch(error => {
            console.error('Error submitting assessment:', error);
            // Calculate correct answers for fallback
            let correctCount = 0;
            questions.forEach((question) => {
                if (answers[question.id] === question.correct) {
                    correctCount++;
                }
            });
            
            // Fallback to local results
            handleAssessmentResult({
                score_percentage: score,
                correct_answers: correctCount,
                total_questions: questions.length,
                time_taken: timeTaken,
                xp_earned: 50,
                level_up: false,
                new_achievements: [],
                module_completed: false,
                next_module_unlocked: null
            });
        });
    }
    
    function handleAssessmentResult(data) {
        // Show results
        document.getElementById('assessment-quiz').style.display = 'none';
        document.getElementById('assessment-results').style.display = 'block';
        
        document.getElementById('final-score').textContent = Math.round(data.score_percentage) + '%';
        document.getElementById('correct-count').textContent = `${data.correct_answers}/${data.total_questions}`;
        document.getElementById('time-taken').textContent = formatTime(data.time_taken);
        document.getElementById('xp-earned').textContent = `+${data.xp_earned} XP`;
        
        // Update score circle color
        const scoreCircle = document.querySelector('.score-circle');
        if (data.score_percentage >= 80) {
            scoreCircle.style.background = 'var(--color-success)';
        } else if (data.score_percentage >= 70) {
            scoreCircle.style.background = 'var(--color-warning)';
        } else {
            scoreCircle.style.background = 'var(--color-error)';
        }
        
        // Handle level up
        if (data.level_up) {
            showLevelUpNotification(data.new_level);
        }
        
        // Handle achievements
        if (data.new_achievements && data.new_achievements.length > 0) {
            showAchievementNotification(data.new_achievements);
        }
        
        // Handle module completion
        if (data.module_completed) {
            showModuleCompletionNotification(data.next_module_unlocked);
            
            // Handle module completion achievements
            if (data.module_achievements && data.module_achievements.length > 0) {
                showAchievementNotification(data.module_achievements);
            }
        }
        
        // Update UI based on completion status
        const completeBtn = document.getElementById('complete-module');
        const reviewBtn = document.getElementById('review-answers');
        
        if (data.module_completed) {
            completeBtn.innerHTML = '<i class="fas fa-trophy"></i> Module Complete! Go to Learning Modules';
            completeBtn.classList.add('btn--success');
        } else {
            completeBtn.innerHTML = '<i class="fas fa-trophy"></i> Complete Module & Unlock Next';
        }
        
        // Show review button if there are results
        if (data.results && data.results.length > 0) {
            reviewBtn.style.display = 'inline-block';
            // Store results for review
            window.assessmentResults = data.results;
        }
        
        // Store assessment completion data for module completion
        window.assessmentCompleted = true;
        window.assessmentData = data;
        
        // Enable the complete module button now that assessment is done
        completeBtn.disabled = false;
        completeBtn.style.opacity = '1';
        
        console.log('Assessment completed with data:', data);
    }
    
    function showLevelUpNotification(newLevel) {
        // Create level up notification
        const notification = document.createElement('div');
        notification.className = 'level-up-notification';
        notification.innerHTML = `
            <div class="notification-content">
                <h3>üéâ Level Up!</h3>
                <p>Congratulations! You've reached Level ${newLevel}!</p>
            </div>
        `;
        
        // Add styles
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--color-success);
            color: white;
            padding: 20px;
            border-radius: 8px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        `;
        
        document.body.appendChild(notification);
        
        // Remove after 5 seconds
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }
    
    function showAchievementNotification(achievements) {
        achievements.forEach(achievement => {
            // Use the consolidated notification system to prevent overlap
            if (window.gamificationEngine) {
                window.gamificationEngine.showAchievementNotification(achievement);
            } else {
                // Fallback to app.js notification system
                if (window.stateManager) {
                    window.stateManager.showNotification(
                        'üèÜ Achievement Unlocked!',
                        `${achievement.name}: ${achievement.description} (+${achievement.xp_reward} XP)`,
                        'success'
                    );
                }
            }
        });
    }
    
    function showModuleCompletionNotification(nextModule) {
        let title = 'üéâ Module Complete!';
        let message = 'Great job mastering this security concept!';
        
        if (nextModule) {
            message += ` Next module ${nextModule} is now unlocked!`;
        } else {
            message += ' You\'ve completed all modules!';
        }
        
        // Use the consolidated notification system to prevent overlap
        if (window.gamificationEngine) {
            window.gamificationEngine.showNotification({
                type: 'module',
                icon: 'üéâ',
                title: title,
                message: message,
                special: true,
                duration: 8000
            });
        } else {
            // Fallback to app.js notification system
            if (window.stateManager) {
                window.stateManager.showNotification(title, message, 'success');
            }
        }
    }
    
    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
    
    function completeModuleAndUnlockNext(moduleId, score) {
        console.log('üèÜ Completing module and unlocking next:', moduleId, 'Score:', score);
        
        // Check if assessment was actually completed
        if (!window.assessmentCompleted) {
            showNotification('Please complete the assessment first!', 'error');
            return;
        }
        
        // Show loading state
        const completeBtn = document.getElementById('complete-module');
        const originalText = completeBtn.innerHTML;
        completeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Completing Module...';
        completeBtn.disabled = true;
        
        // Use assessment data if available
        const assessmentData = window.assessmentData || {};
        const finalScore = assessmentData.score_percentage || score;
        
        console.log('Using final score:', finalScore);
        
        // Enhanced completion process - combine all debug functionality
        try {
            // 1. Update gamification engine
            if (window.gamificationEngine && window.gamificationEngine.userProfile) {
                console.log('Completing all activities in gamification engine...');
                const activities = ['documentation', 'animation', 'lab', 'assessment'];
                activities.forEach(activity => {
                    console.log(`Completing activity: ${activity}`);
                    if (typeof window.gamificationEngine.completeActivity === 'function') {
                        window.gamificationEngine.completeActivity(moduleId, activity, finalScore);
                    }
                });
                
                // Complete the module
                if (typeof window.gamificationEngine.completeModule === 'function') {
                    window.gamificationEngine.completeModule(moduleId);
                }
                
                // Save to localStorage
                if (typeof window.gamificationEngine.saveUserProfile === 'function') {
                    window.gamificationEngine.saveUserProfile();
                }
                
                const unlockedModules = window.gamificationEngine.userProfile.unlockedModules;
                console.log('Gamification engine updated. Unlocked modules:', 
                    unlockedModules ? Array.from(unlockedModules) : []);
            } else {
                console.warn('Gamification engine not available or missing userProfile');
            }
            
            // 2. Update learning path system
            if (window.learningPath) {
                console.log('Updating learning path system...');
                const activities = ['documentation', 'animation', 'lab', 'quiz'];
                activities.forEach(activity => {
                    window.learningPath.completeActivity(moduleId, activity, {
                        score: finalScore,
                        timeSpent: (window.assessmentData?.time_taken || 300)
                    });
                });
            }
            
            // 3. Update StateManager
            if (window.stateManager) {
                console.log('Updating StateManager...');
                window.stateManager.completeModule(moduleId);
                
                // Unlock next module based on sequence
                const moduleOrder = ['A01', 'A02', 'A03', 'A04', 'A05', 'A06', 'A07', 'A08', 'A09', 'A10'];
                const currentIndex = moduleOrder.indexOf(moduleId);
                if (currentIndex >= 0 && currentIndex < moduleOrder.length - 1) {
                    const nextModule = moduleOrder[currentIndex + 1];
                    window.stateManager.unlockModule(nextModule);
                    console.log(`Next module ${nextModule} unlocked via StateManager`);
                }
            }
            
            // 4. Call backend API to complete activity and refresh frontend
            fetch('/api/complete-activity', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    module_id: moduleId,
                    activity_type: 'assessment',
                    score: finalScore,
                    time_spent: (window.assessmentData?.time_taken || 300)
                })
            })
            .then(response => response.json())
            .then(async result => {
                console.log('‚úÖ Backend API response:', result);
                
                // Force update StateManager if available
                if (window.stateManager && result.unlocked_modules) {
                    console.log('üîÑ Updating StateManager with unlocked modules...');
                    result.unlocked_modules.forEach(moduleId => {
                        window.stateManager.unlockModule(moduleId);
                    });
                }
                
                // Update gamification engine with unlocked modules
                if (window.gamificationEngine && result.unlocked_modules) {
                    console.log('üîÑ Updating gamification engine with unlocked modules...');
                    result.unlocked_modules.forEach(moduleId => {
                        window.gamificationEngine.userProfile.unlockedModules.add(moduleId);
                    });
                    window.gamificationEngine.saveState();
                }
                
                // Show appropriate notification
                let message = 'üéâ Module Completed!';
                if (result.next_module_unlocked) {
                    message += ` Next module ${result.next_module_unlocked} unlocked!`;
                } else if (result.module_completed) {
                    message += ' Great job mastering this security concept!';
                }
                showNotification(message, 'success');
                
                // Navigate to dashboard to see updated stats
                setTimeout(() => {
                    // Add a cache-busting parameter to force fresh data
                    window.location.href = '/dashboard?refresh=' + Date.now();
                }, 2000);
            })
            .catch(error => {
                console.error('‚ùå Error in completion process:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    gamificationEngine: !!window.gamificationEngine,
                    userProfile: !!(window.gamificationEngine && window.gamificationEngine.userProfile),
                    learningPath: !!window.learningPath
                });
                
                // Show error but still try to navigate
                showNotification('‚ö†Ô∏è Some completion steps failed, but progress was saved', 'warning');
                
                setTimeout(() => {
                    window.location.href = '/dashboard#modules';
                }, 2000);
            });
            
        } catch (error) {
            console.error('‚ùå Error in completion process:', error);
            showNotification(`Error: ${error.message}`, 'error');
            
            completeBtn.innerHTML = originalText;
            completeBtn.disabled = false;
        }
    }
    
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <span>${message}</span>
                <button class="notification-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
            </div>
        `;
        
        // Add styles
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? 'var(--color-success)' : type === 'error' ? 'var(--color-error)' : 'var(--color-primary)'};
            color: white;
            padding: 16px 20px;
            border-radius: 8px;
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
            max-width: 350px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        
        document.body.appendChild(notification);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
    
    // Add event listeners for result actions
    document.addEventListener('click', function(e) {
        if (e.target.id === 'complete-module') {
            const moduleId = e.target.dataset.moduleId;
            const score = window.assessmentScore || 85;
            
            // Mark module as completed and unlock next module
            completeModuleAndUnlockNext(moduleId, score);
        } else if (e.target.id === 'retake-assessment') {
            location.reload();
        } else if (e.target.id === 'review-answers') {
            showReviewModal();
        }
    });
    
    function showReviewModal() {
        const results = window.assessmentResults;
        if (!results || results.length === 0) {
            alert('No results to review');
            return;
        }
        
        let reviewHTML = '<div class="review-container">';
        results.forEach((result, index) => {
            const isCorrect = result.is_correct;
            const statusIcon = isCorrect ? '‚úÖ' : '‚ùå';
            const statusClass = isCorrect ? 'correct' : 'incorrect';
            
            reviewHTML += `
                <div class="review-item ${statusClass}">
                    <div class="review-header">
                        <span class="review-number">Question ${index + 1}</span>
                        <span class="review-status">${statusIcon} ${isCorrect ? 'Correct' : 'Incorrect'}</span>
                    </div>
                    <div class="review-question">${result.question_text}</div>
                    <div class="review-answers">
                        <div class="user-answer">
                            <strong>Your Answer:</strong> ${result.user_answer}
                        </div>
                        ${!isCorrect ? `
                            <div class="correct-answer">
                                <strong>Correct Answer:</strong> ${result.correct_answer}
                            </div>
                        ` : ''}
                    </div>
                    ${result.explanation ? `
                        <div class="review-explanation">
                            <strong>Explanation:</strong> ${result.explanation}
                        </div>
                    ` : ''}
                </div>
            `;
        });
        reviewHTML += '</div>';
        
        // Create modal
        const modal = document.createElement('div');
        modal.className = 'modal review-modal';
        modal.style.display = 'flex';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2>üìã Review Your Answers</h2>
                    <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                </div>
                <div class="modal-body">
                    ${reviewHTML}
                </div>
                <div class="modal-footer">
                    <button class="btn btn--outline" onclick="this.closest('.modal').remove()">Close</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
    
    // Badge popup helper
    function showBadgePopup() {
        const modal = document.getElementById('badge-modal');
        if (!modal) return;
        modal.classList.remove('hidden');
    }
    // Robust close handlers (both header X and footer button)
    document.addEventListener('click', function(e){
        if (e.target && (e.target.id === 'badge-close' || e.target.classList.contains('modal-close'))) {
            const m = document.getElementById('badge-modal');
            if (m) m.classList.add('hidden');
        }
    });
});
</script>
{% block modals %}
<div id="badge-modal" class="modal hidden" role="dialog" aria-modal="true">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üèÜ Badge Earned!</h3>
      <button id="badge-close" class="modal-close">&times;</button>
    </div>
    <div class="modal-body" style="text-align:center; padding: 16px;">
      <div style="font-size:64px; margin-bottom:12px;">üéñÔ∏è</div>
      <p>Congratulations! You completed <strong>{{ module.title }}</strong> and earned a badge.</p>
    </div>
    <div class="modal-footer" style="display:flex; justify-content:center; gap:8px; padding: 12px;">
      <button id="badge-close" class="btn btn--primary">Awesome!</button>
    </div>
  </div>
  <style>
    .modal.hidden{ display:none; }
  </style>
</div>
{% endblock %}
{% endblock %}
